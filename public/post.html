<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="t">文章 · Ray</title>
  <link rel="stylesheet" href="/assets/style.css" />
  <script type="module">
    const $ = (s)=>document.querySelector(s);
    function getId(){
      const u = new URL(location.href);
      return u.searchParams.get('id')
        || (u.hash ? new URLSearchParams(u.hash.slice(1)).get('id') : null)
        || (location.pathname.match(/post(?:\.html)?\/(.+)$/)?.[1] ?? null);
    }
    const id = getId();
    const titleEl = $('#t');
    const hEl = $('#h');
    const bodyEl = $('#body');
    const metaEl = $('#meta');
    const coverEl = $('#cover');
    const listEl = $('#comments');
    const form = $('#cform');

    const admin = {
      get token(){ return localStorage.getItem('admin_token') || ''; },
      get isAuthed(){ return !!localStorage.getItem('admin_token'); }
    };

    async function load(){
      if(!id){ bodyEl.textContent = '缺少文章 ID'; return; }
      try{
        const r = await fetch(`/api/posts/${id}`);
        if(!r.ok){ bodyEl.textContent = '找不到文章'; return; }
        const d = await r.json();
        titleEl.textContent = d.title + ' · Ray';
        hEl.textContent = d.title || '（無標題）';
        metaEl.textContent = new Date(d.created_at).toLocaleString();
        if(d.cover_url){ coverEl.src = d.cover_url; coverEl.style.display=''; } else { coverEl.style.display='none'; }
        bodyEl.innerHTML = (d.content ?? '').toString().replace(/</g,'&lt;').replace(/\n/g,'<br/>');
        await loadComments();
      }catch(e){
        console.error(e);
        bodyEl.textContent = '載入失敗，稍後再試';
      }
    }

    async function loadComments(){
      try{
        const r = await fetch(`/api/comments?post_id=${encodeURIComponent(id)}`);
        if(!r.ok){ listEl.innerHTML = '<li class="muted">讀取留言失敗</li>'; return; }
        const {items=[]} = await r.json();
        listEl.innerHTML = items.map(c => \`
          <li class="comment" data-animate>
            <div class="comment-meta">\${c.author || '訪客'} · \${new Date(c.created_at).toLocaleString()}</div>
            <div class="comment-body">\${(c.body||'').replace(/</g,'&lt;')}</div>
            \${admin.isAuthed ? '<button class="mini danger" data-del="'+c.id+'">刪除</button>' : ''}
          </li>\`
        ).join('') || '<li class="muted">暫無留言</li>';
        if(admin.isAuthed){
          document.querySelectorAll('[data-del]').forEach(btn=>{
            btn.onclick = async ()=>{
              if(!confirm('刪除此留言？')) return;
              const cid = btn.getAttribute('data-del');
              const rr = await fetch('/api/comments/'+cid,{ method:'DELETE', headers:{'x-admin-token': admin.token} });
              if(rr.ok) loadComments(); else alert('刪除失敗');
            };
          });
        }
        const els = document.querySelectorAll('[data-animate]');
        const io = new IntersectionObserver((entries)=>{
          entries.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('in'); } });
        },{threshold:0.1});
        els.forEach(el=>io.observe(el));
      }catch(e){
        console.error(e);
        listEl.innerHTML = '<li class="muted">讀取留言失敗</li>';
      }
    }

    form?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(form);
      const payload = Object.fromEntries(fd.entries());
      payload.post_id = id;
      const r = await fetch('/api/comments',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!r.ok){ alert('留言失敗'); return; }
      form.reset();
      await loadComments();
    });

    load();
  </script>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="/">R</a>
      <nav class="nav">
        <a href="/" class="nav-link">首頁</a>
        <a href="/admin.html" class="nav-link">管理</a>
      </nav>
    </div>
  </header>
  <main class="container">
    <article class="post card">
      <img id="cover" class="post-cover" alt="" style="display:none"/>
      <h2 id="h" class="post-title" data-animate>載入中…</h2>
      <div id="meta" class="post-meta"></div>
      <div id="body" class="post-body"></div>
    </article>

    <section class="comments">
      <h3>留言</h3>
      <ul id="comments" class="comment-list"></ul>
      <form id="cform" class="card">
        <label>暱稱 <input name="author" placeholder="匿名"></label>
        <label>內容 <textarea name="body" required placeholder="寫點什麼吧…"></textarea></label>
        <button type="submit">發表</button>
      </form>
    </section>
  </main>
  <footer class="site-footer">
    <div class="container">
      <p>© <span id="y"></span> Ray</p>
    </div>
  </footer>
</body>
</html>
